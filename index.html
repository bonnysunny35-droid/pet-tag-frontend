<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qurioussa AI — Personalized 3D Design Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0b1220" />
</head>
<body class="h-full bg-slate-950 text-slate-100">
  <!-- Hero -->
  <header class="px-4 pt-10 pb-6">
    <div class="mx-auto max-w-6xl">
      <div class="inline-flex items-center gap-3 rounded-2xl bg-gradient-to-r from-cyan-400/20 to-fuchsia-500/20 px-4 py-2 ring-1 ring-white/10">
        <span class="text-2xl">✨</span>
        <span class="text-sm tracking-wide text-slate-300">Qurioussa AI Studio</span>
      </div>
      <h1 class="mt-4 text-4xl font-semibold tracking-tight sm:text-5xl">Design. Generate. Manufacture.</h1>
      <p class="mt-2 max-w-3xl text-slate-300 text-lg">
        Welcome to <strong>Qurioussa AI</strong> — an intelligent co-creation platform that helps you design, visualize, and personalize products instantly using AI.
      </p>
    </div>
  </header>

  <!-- Main -->
  <main class="px-4 pb-16">
    <div class="mx-auto grid max-w-6xl gap-6 md:grid-cols-2">
      <!-- Form -->
      <section class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur-sm">
        <h2 class="text-lg font-medium mb-4">1) Describe your idea</h2>

        <form id="tag-form" class="space-y-4" novalidate>
          <div>
            <label class="block text-sm text-slate-300 mb-1">Product name / label</label>
            <input name="name" placeholder="BELLA" required
                   class="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-400"/>
          </div>

          <div>
            <label class="block text-sm text-slate-300 mb-1">Base shape</label>
            <select name="shape"
                    class="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400">
              <option value="circle">Circle</option>
              <option value="bone">Bone</option>
              <option value="heart">Heart</option>
            </select>
          </div>

          <div>
            <label class="block text-sm text-slate-300 mb-1">Reference image (optional)</label>
            <input type="file" name="photo" accept="image/*"
                   class="w-full rounded-xl border border-white/10 bg-white/5 file:mr-3 file:rounded-lg file:border-0 file:bg-cyan-500 file:px-3 file:py-2 file:text-sm file:text-white hover:file:bg-cyan-600"/>
            <p class="mt-1 text-xs text-slate-400">Future version: generate design style via AI vision model.</p>
          </div>

          <button type="submit"
                  class="group inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-cyan-500 to-fuchsia-500 px-4 py-2 font-medium text-white shadow-lg hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-cyan-400">
            <span>Generate Design</span>
            <svg class="h-4 w-4 transition -translate-x-0.5 group-hover:translate-x-0" viewBox="0 0 24 24" fill="none">
              <path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>

          <div id="result" class="mt-2 text-sm text-slate-300"></div>
        </form>
      </section>

      <!-- Viewer -->
      <section class="rounded-2xl border border-white/10 bg-white/5 p-6 backdrop-blur-sm">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-medium">2) Preview & export</h2>
          <span id="status" class="text-xs text-slate-400">Idle</span>
        </div>

        <div id="viewer" class="h-[420px] w-full rounded-xl border border-white/10 bg-slate-900"></div>
        <p class="mt-2 text-xs text-slate-400">Drag to rotate · Scroll to zoom · Right-click to pan</p>
      </section>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed bottom-4 left-1/2 z-50 hidden -translate-x-1/2 rounded-xl bg-red-500 px-4 py-2 text-sm text-white shadow-lg"></div>

<script type="module">
  // ======= IMPORTS (ES Modules) =======
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
  import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
  import { STLLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/STLLoader.js";

  // ======= CONFIG =======
  window.QURIOUSSA_BUILD = "v7";
  const API_BASE = "https://pet-tag-backend-ed8a.onrender.com"; // <-- PUT YOUR RENDER URL
  const API_GENERATE_URL = API_BASE + "/generate";
  const API_DOWNLOAD = (p) => API_BASE + "/download?file=" + encodeURIComponent(p);

  const $ = (s) => document.querySelector(s);
  const statusEl = $('#status');
  const resultEl = $('#result');
  function showStatus(t){ if(statusEl) statusEl.textContent=t; }
  function showToast(msg){
    const toast = document.getElementById('toast');
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.remove('hidden');
    setTimeout(()=>toast.classList.add('hidden'), 2500);
  }

  // ======= THREE.JS VIEWER =======
  let scene, camera, renderer, controls, loader, mesh;

  function initViewer() {
    const container = document.getElementById('viewer');
    const w = container.clientWidth, h = container.clientHeight;

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b1220);

    camera = new THREE.PerspectiveCamera(50, w/h, 0.1, 5000);
    camera.position.set(0, 80, 180);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(w, h);
    container.innerHTML = "";
    container.appendChild(renderer.domElement);

    scene.add(new THREE.DirectionalLight(0xffffff, 1));
    scene.add(new THREE.AmbientLight(0xffffff, 0.35));

    const grid = new THREE.GridHelper(400, 40, 0x334155, 0x1f2937);
    grid.position.y = -20;
    scene.add(grid);
    scene.add(new THREE.AxesHelper(40));

    controls = new OrbitControls(camera, renderer.domElement);
    loader = new STLLoader();

    (function animate(){ requestAnimationFrame(animate); renderer.render(scene, camera); })();

    window.addEventListener('resize', () => {
      const w2 = container.clientWidth, h2 = container.clientHeight;
      camera.aspect = w2/h2; camera.updateProjectionMatrix();
      renderer.setSize(w2, h2);
    });
  }

  async function loadSTL(url) {
    // reachability check (helps surface 404/CORS quickly)
    try {
      const head = await fetch(url, { method: 'GET' });
      if (!head.ok) { showToast('STL not accessible (' + head.status + ')'); return; }
    } catch (e) {
      showToast('Could not fetch STL URL'); return;
    }

    loader.load(
      url,
      (geometry) => {
        if (mesh) { scene.remove(mesh); mesh.geometry.dispose(); }

        const material = new THREE.MeshPhongMaterial({ flatShading: true });
        mesh = new THREE.Mesh(geometry, material);

        geometry.computeBoundingBox();
        const bb = geometry.boundingBox;
        const center = new THREE.Vector3().addVectors(bb.min, bb.max).multiplyScalar(0.5);
        geometry.translate(-center.x, -center.y, -center.z);
        scene.add(mesh);

        const size = new THREE.Vector3().subVectors(bb.max, bb.min);
        const maxDim = Math.max(size.x, size.y, size.z) || 50;
        const dist = maxDim * 2.2;
        camera.position.set(0, maxDim * 0.8, dist);
        camera.near = 0.1;
        camera.far = Math.max(5000, dist * 10);
        camera.updateProjectionMatrix();
        controls.target.set(0, 0, 0);
        controls.update();

        console.log('STL loaded. bbox size:', size);
      },
      undefined,
      (err) => {
        console.error('STL load error:', err);
        showToast('Failed to parse STL');
      }
    );
  }

  // ======= FORM HANDLER =======
  document.getElementById('tag-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showStatus('Generating…');
    resultEl.textContent = '⏳ Generating model...';

    const data = new FormData(e.target);
    // don’t send empty photo
    const fileInput = e.target.querySelector('input[name="photo"]');
    if (!fileInput || !fileInput.files || !fileInput.files[0]) data.delete('photo');

    try {
      const res = await fetch(API_GENERATE_URL, { method: 'POST', body: data });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      const json = await res.json();
      if (json.stl_path) {
        const url = API_DOWNLOAD(json.stl_path);
        resultEl.innerHTML = `✅ Model ready — <a class="text-cyan-300 underline hover:text-cyan-200" href="${url}" target="_blank">Download STL</a>`;
        // ensure viewer is initialized once
        if (!renderer) initViewer();
        loadSTL(url);
        showStatus('Preview ready');
      } else {
        throw new Error('Unexpected response: ' + JSON.stringify(json));
      }
    } catch (err) {
      console.error('Generate failed:', err);
      resultEl.textContent = '❌ Could not reach backend: ' + err.message;
      showToast('Backend error — see console');
      showStatus('Error');
    }
  });

  // Tiny health badge (helps verify live build + API)
  (async () => {
    const badge = document.createElement('div');
    badge.style.cssText = "position:fixed;bottom:8px;left:8px;background:#1f2937;color:#fff;padding:6px 10px;border-radius:8px;font:12px system-ui;z-index:9999";
    badge.textContent = `Build ${window.QURIOUSSA_BUILD} — Pinging API…`;
    document.body.appendChild(badge);
    try {
      const r = await fetch(API_BASE + "/health");
      const t = await r.text();
      badge.textContent = `Build ${window.QURIOUSSA_BUILD} — API ${r.ok ? "OK" : r.status} ${t}`;
    } catch (e) {
      badge.textContent = `Build ${window.QURIOUSSA_BUILD} — API unreachable`;
    }
  })();
</script>


</body>
</html>
